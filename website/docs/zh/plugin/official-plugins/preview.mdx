---
tag: new
---

# @rspress/plugin-preview <SourceCode href="https://github.com/web-infra-dev/rspress/tree/main/packages/plugin-preview" />

import { SourceCode, PackageManagerTabs, Tabs, Tab } from '@theme';

用于预览 md(x) 文件代码块中的组件，适合编写组件库文档。

## 安装

<PackageManagerTabs command="add @rspress/plugin-preview -D" />

## 使用

### 1. 安装插件

首先在配置文件中写入以下的配置：

```ts title="rspress.config.ts" twoslash
import { defineConfig } from '@rspress/core';
import { pluginPreview } from '@rspress/plugin-preview';

export default defineConfig({
  plugins: [pluginPreview()],
});
```

### 2. 在 mdx 文件中使用

在 mdx 文件中使用 ` ```tsx preview ` 的语法：

````mdx title="example.mdx"
```tsx preview
import { useState } from 'react';

function App() {
  const [count, setCount] = useState(0);

  return (
    <div style={{ textAlign: 'center' }}>
      <p>当前计数: {count}</p>
      <button onClick={() => setCount(count + 1)}>+</button>
      <button onClick={() => setCount(count - 1)}>-</button>
    </div>
  );
}

export default App;
```
````

它的渲染结果如下：

```tsx preview
import { useState } from 'react';

function App() {
  const [count, setCount] = useState(0);

  return (
    <div style={{ textAlign: 'center' }}>
      <p>当前计数: {count}</p>
      <button onClick={() => setCount(count + 1)}>+</button>
      <button onClick={() => setCount(count - 1)}>-</button>
    </div>
  );
}

export default App;
```

:::tip 提示

1. 目前只在 `.mdx` 文件中生效。
2. 需要将组件作为 default 导出，Rspress 会自动渲染这个组件。

:::

### 3. 将组件代码写在其他文件中

除了将组件代码写在 mdx 文件的代码块中，你还可以配合[文件代码块](../../guide/use-mdx/code-blocks.mdx#file-code-block) 一起使用，将示例代码写在其他文件中。

````mdx title="example.mdx"
```tsx file="./_demo.tsx" preview

```
````

```tsx title="_demo.tsx" file="./_demo.tsx"

```

它的渲染结果如下：

```tsx file="./_demo.tsx" preview

```

## 使用 iframe 预览模式 \{#preview-mode}

该插件内置了多种预览模式，通过调整 `preview="..."` meta 信息，例如 ` ```tsx preview="iframe-follow" `，可以切换不同的预览模式。[defaultPreviewMode](#defaultPreviewMode) 配置项可以用来配置默认的预览模式。

:::tip 提示

你可以选择使用带有 iframe 的预览模式进行组件展示，以隔离文档和组件的运行环境，避免样式冲突等问题，或者选择便于移动端组件展示的预览模式。

:::

### `preview="internal"`

默认的 `"internal"` 模式效果如下：

语法为：

````mdx
```tsx file="./_demo.tsx" preview="internal"

```
````

渲染结果为：

```tsx file="./_demo.tsx" preview="internal"

```

### `preview="iframe-follow"`

`"iframe-follow"` 模式效果如下：

语法为：

````mdx
```tsx file="./_demo.tsx" preview="iframe-follow"

```
````

渲染结果为：

```tsx file="./_demo.tsx" preview="iframe-follow"

```

### `preview="iframe-fixed"`

`"iframe-fixed"` 模式效果如下：

语法为：

````mdx
```tsx file="./_demo.tsx" preview="iframe-fixed"

```
````

渲染结果为：

![](https://lf3-static.bytednsdoc.com/obj/eden-cn/uhbfnupenuhf/rspress/demo-preview-mobile-fixed.png)

## 配置

这个插件接受一个对象参数，类型如下:

```ts
interface PreviewOptions {
  defaultRenderMode?: 'pure' | 'preview';
  defaultPreviewMode?: 'internal' | 'iframe-fixed' | 'iframe-follow';
  iframeOptions?: IframeOptions;
  previewLanguages?: string[];
  previewCodeTransform?: (codeInfo: {
    language: string;
    code: string;
  }) => string;
}

interface IframeOptions {
  framework?: 'react' | 'solid';
  devPort?: number;
  builderConfig?: RsbuildConfig;
}
```

### defaultRenderMode

- **类型**： `string`
- **默认值**： `pure`

支持用户配置没有主动声明 `pure` 或 `preview` 的内部代码块的默认行为，默认为 `pure`。

- ` ```tsx pure`: 渲染为普通代码块。
- ` ```tsx `: 根据 `defaultRenderMode` 配置渲染。
- ` ```tsx preview`: 渲染为预览组件。

### defaultPreviewMode

- **类型**： `"internal" | "iframe-follow" | "iframe-fixed" `
- **默认值**： `internal`

`defaultPreviewMode` 参数用于配置 ` ```tsx preview` 时的 [预览模式](#preview-mode)，默认为 `"internal"`

- ` ```tsx preview`: 根据 `defaultPreviewMode` 配置渲染。
- ` ```tsx preview="internal"`: 使用内嵌模式渲染。
- ` ```tsx preview="iframe-follow"`: 使用跟随模式渲染。
- ` ```tsx preview="iframe-fixed"`: 使用固定模式渲染。

### iframeOptions

该插件会启动一个全新的 Rsbuild 实例用于 `iframe` 模式代码块的开发服务器和构建产物，因此编译流程与 Rspress 文档完全隔离，可自主配置。

#### iframeOptions.devPort

- **类型**： `number`
- **默认值**： `7890`

当默认端口冲突时，你可以手动配置组件的 dev server 端口。

#### iframeOptions.builderConfig

配置 iframe 的构建配置，例如添加一些全局代码逻辑。

#### iframeOptions.customEntry

配置自定义入口支持其他 `Web` 框架，例如 `Vue`。

仅设置 `preview="iframe-follow"` 时可使用 customEntry。

以下是一个使用 Vue 框架的示例：

```ts
import { defineConfig } from '@rspress/core';
import { pluginPreview } from '@rspress/plugin-preview';
import { pluginVue } from '@rsbuild/plugin-vue';

export default defineConfig({
  // ...
  plugins: [
    pluginPreview({
      previewMode: 'iframe',
      previewLanguages: ['vue'],
      iframeOptions: {
        position: 'follow',
        customEntry: ({ entryCssPath, demoPath }) => {
          return `
          import { createApp } from 'vue';
          import App from ${JSON.stringify(demoPath)};
          import ${JSON.stringify(entryCssPath)};
          createApp(App).mount('#root');
          `;
        },
        builderConfig: {
          plugins: [pluginVue()],
        },
      },
    }),
  ],
});
```

### previewLanguages

- **类型**： `string[]`
- **默认值**： `['jsx', 'tsx']`

支持预览的代码语言，默认支持 jsx 和 tsx 代码。如果你需要支持其它格式的代码，如 json/yaml, 可以配合下面的 `previewCodeTransform` 配置一起使用。

### previewCodeTransform

- **类型**： `(codeInfo: { language: string; code: string }) => string`
- **默认值**： `({ code }) => code`

预览前对代码进行自定义的转换。以 JSON 代码为例，如果你想要通过自定义的转换逻辑渲染一段 JSON Schema：

```json
{
  "type": "div",
  "children": "Render from JSON"
}
```

可以做如下配置：

```ts
pluginPreview({
  // 注意添加默认的 jsx 和 tsx
  previewLanguages: ['jsx', 'tsx', 'json'],
  previewCodeTransform(codeInfo) {
    if (codeInfo.language === 'json') {
      return `
import React from 'react';

const json = ${codeInfo.code};

export default function() {
return React.createElement(json.type, null, json.children);
}
`;
    } else {
      return codeInfo.code;
    }
  },
});
```

这样，最后会渲染出自定义逻辑转换后的组件代码。

## 从 V1 迁移

如果你从 Rspress V1 中迁移，插件的功能本身没有变化，仅 mdx 源码的书写方式会有以下调整：

- `<code src="./foo.tsx"/>` 应该迁移为 [文件代码块](../../guide/use-mdx/code-blocks.mdx#file-code-block) ` ```tsx file="./foo.tsx"`。

- `defaultPreviewMode` 配置项代替了 `iframeOptions.position` 和 `previewMode`。

:::tip 迁移示例

**示例 1**：

**Before**：需要同时在 `rspress.config.ts` 和 mdx 文件中进行声明。

```ts
pluginPreview({
  previewMode: 'iframe',
  iframeOptions: { position: 'fixed' },
});
```

````mdx
```tsx preview

```
````

**After**：仅需要在 mdx 文件中进行声明即可。

````mdx
```tsx preview="iframe-fixed"

```
````

**示例 2**：

**Before**：使用了 `iframe` 或者 `previewMode="iframe"` 属性。

````mdx
```tsx iframe
// 或者

<code src="./_demo.tsx" previewMode="iframe" />
```
````

**After**：仅有 `preview="..."` 一个属性。

````mdx
```tsx preview="iframe-follow"

```

```tsx file="./_demo.tsx" preview="iframe-follow"

```
````

:::

- `defaultRenderMode` 默认值从 `preview` 改为了 `pure`。
