# @rspress/plugin-preview <SourceCode href="https://github.com/web-infra-dev/rspress/tree/main/packages/plugin-preview" />

import { SourceCode, PackageManagerTabs, Tabs, Tab } from '@theme';

用于预览 md(x) 文件代码块中的组件。

## 安装

<PackageManagerTabs command="add @rspress/plugin-preview -D" />

## 使用

### 1. 安装插件

首先在配置文件中写入以下的配置：

```ts title="rspress.config.ts" twoslash
import { defineConfig } from '@rspress/core';
import { pluginPreview } from '@rspress/plugin-preview';

export default defineConfig({
  plugins: [pluginPreview()],
});
```

### 2. 在 mdx 文件中使用

在 mdx 文件中使用 ` ```tsx preview ` 的语法：

````mdx title="example.mdx"
```tsx preview
function App() {
  return <div style={{ color: 'gray' }}>Hello World</div>;
}

export default App;
```
````

它的渲染结果如下：

```tsx preview
function App() {
  return <div style={{ color: 'gray' }}>Hello World</div>;
}

export default App;
```

:::tip 提示

1. 目前只在 `.mdx` 文件中生效。
2. 需要将组件作为 default 导出，Rspress 会自动渲染这个组件。

:::

### 3. 将组件代码写在其他文件中

除了将组件代码写在 mdx 文件的代码块中，你还可以配合[文件代码块](../../guide/use-mdx/code-blocks.mdx#file-code-block) 一起使用，将示例代码写在其他文件中。

````mdx title="example.mdx"
```tsx file="./_demo.tsx" preview

```
````

```tsx title="_demo.tsx" file="./_demo.tsx"

```

它的渲染结果如下：

```tsx file="./_demo.tsx" preview

```

:::tip 提示

如果你从 Rspress V1 中迁移，`<code src="./foo.tsx"/>` 应该迁移为 ` ```tsx file="./foo.tsx"`。

:::

## 配置

这个插件接受一个对象参数，类型如下:

```ts
interface PreviewOptions {
  defaultRenderMode?: 'pure' | 'preview';
  defaultPreviewMode?: 'internal' | 'iframe-fixed' | 'iframe-follow';
  iframeOptions?: IframeOptions;
  previewLanguages?: string[];
  previewCodeTransform?: (codeInfo: {
    language: string;
    code: string;
  }) => string;
}

interface IframeOptions {
  framework?: 'react' | 'solid';
  devPort?: number;
  builderConfig?: RsbuildConfig;
}
```

### defaultRenderMode

- **类型**： `string`
- **默认值**： `pure`

支持用户配置没有主动声明 `pure` 或 `preview` 标识符的内部代码块的默认行为，默认为 `pure`。

- ` ```tsx pure`: 渲染为普通代码块。
- ` ```tsx `: 根据 `defaultRenderMode` 配置渲染。
- ` ```tsx preview`: 渲染为预览组件。

### defaultPreviewMode

- **类型**： `"internal" | "iframe-follow" | "iframe-fixed" `
- **默认值**： `internal`

`defaultPreviewMode` 参数用于指定预览组件是否内置，默认为 `"internal"`，展示效果如下：

```tsx file="./_demo.tsx" preview

```

`"iframe-follow"` 模式效果如下：

```tsx file="./_demo.tsx" preview="iframe-follow"

```

`"iframe-fixed"` 模式效果如下：

![](https://lf3-static.bytednsdoc.com/obj/eden-cn/uhbfnupenuhf/rspress/demo-preview-mobile-fixed.png)

### iframeOptions

#### iframeOptions.devPort

在 iframe 预览模式下，你可以配置预览组件的 dev server port。

#### iframeOptions.builderConfig

配置 iframe 的构建配置，例如添加一些全局代码逻辑。

#### iframeOptions.customEntry

配置自定义入口支持其他 `Web` 框架，例如 `Vue`。

仅设置 `iframeOptions.position = follow` 时可使用 customEntry。

```ts
import { defineConfig } from '@rspress/core';
import { pluginPreview } from '@rspress/plugin-preview';
import { pluginVue } from '@rsbuild/plugin-vue';

export default defineConfig({
  // ...
  plugins: [
    pluginPreview({
      previewMode: 'iframe',
      previewLanguages: ['vue'],
      iframeOptions: {
        position: 'follow',
        customEntry: ({ entryCssPath, demoPath }) => {
          return `
          import { createApp } from 'vue';
          import App from ${JSON.stringify(demoPath)};
          import ${JSON.stringify(entryCssPath)};
          createApp(App).mount('#root');
          `;
        },
        builderConfig: {
          plugins: [pluginVue()],
        },
      },
    }),
  ],
});
```

### previewLanguages

- **类型**： `string[]`
- **默认值**： `['jsx', 'tsx']`

支持预览的代码语言，默认支持 jsx 和 tsx 代码。如果你需要支持其它格式的代码，如 json/yaml, 可以配合下面的 `previewCodeTransform` 配置一起使用。

### previewCodeTransform

- **类型**： `(codeInfo: { language: string; code: string }) => string`
- **默认值**： `({ code }) => code`

预览前对代码进行自定义的转换。以 JSON 代码为例，如果你想要通过自定义的转换逻辑渲染一段 JSON Schema：

```json
{
  "type": "div",
  "children": "Render from JSON"
}
```

可以做如下配置：

```ts
pluginPreview({
  // 注意添加默认的 jsx 和 tsx
  previewLanguages: ['jsx', 'tsx', 'json'],
  previewCodeTransform(codeInfo) {
    if (codeInfo.language === 'json') {
      return `
import React from 'react';

const json = ${codeInfo.code};

export default function() {
return React.createElement(json.type, null, json.children);
}
`;
    } else {
      return codeInfo.code;
    }
  },
});
```

这样，最后会渲染出自定义逻辑转换后的组件代码。

:::warning 注意

`previewLanguages` 和 `previewCodeTransform` 配置仅对内部组件生效，即对声明在 mdx 文件中的代码块生效，而对于 `code` 标签中声明的外部文件不会生效！

:::
