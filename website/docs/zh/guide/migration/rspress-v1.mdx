# 从 Rspress 1.x 迁移

本文档将帮助你从 Rspress 1.x 迁移到 Rspress V2。

## [重要] Node.js 版本要求

Rspress V2 不再支持 Node.js 16 和 18，请升级到 **Node.js >= 20.9.0**。

推荐使用 Node.js 22 LTS 版本。

## [重要] 包名变更

Rspress V2 将多个包统一整合到 `@rspress/core` 中，原有的 `rspress` 包不再使用。

- before:

```json title="package.json"
{
  "dependencies": {
    "rspress": "^1.x"
  }
}
```

- after:

```json title="package.json"
{
  "dependencies": {
    "@rspress/core": "^V2.0"
  }
}
```

**导入路径变更**

| 旧路径 | 新路径 |
| --- | --- |
| `rspress` / `rspress/config` | `@rspress/core` |
| `rspress/runtime` | `@rspress/core/runtime` |
| `rspress/theme` | `@rspress/core/theme` |
| `@rspress/theme-default` | `@rspress/core/theme-original` |

示例：

- before:

```ts
import { usePageData, useDark } from 'rspress/runtime';
import type { RspressPlugin } from 'rspress';
```

- after:

```ts
import { usePageData, useDark } from '@rspress/core/runtime';
import type { RspressPlugin } from '@rspress/core';
```

### 移除的独立包

以下插件已内置到核心包中，无需单独安装：

- `@rspress/plugin-shiki` - 代码高亮已内置
- `@rspress/plugin-auto-nav-sidebar` - 导航侧边栏已内置
- `@rspress/plugin-container-syntax` - 容器语法已内置
- `@rspress/plugin-last-updated` - 最后更新时间已内置
- `@rspress/plugin-medium-zoom` - 图片缩放已内置

## [重要] 自定义主题改为命名导出

自定义主题不再使用默认导出，改为命名导出。

- before:

```tsx title="theme/index.tsx"
import Theme from 'rspress/theme';

const Layout = () => <Theme.Layout beforeNavTitle={<div>content</div>} />;

export default { ...Theme, Layout };

export * from 'rspress/theme';
```

- after:

```tsx title="theme/index.tsx"
import { Layout as BasicLayout } from '@rspress/core/theme-original';

const Layout = () => <BasicLayout beforeNavTitle={<div>content</div>} />;

export { Layout };

export * from '@rspress/core/theme-original';
```

## [重要] Shiki 代码高亮替代 Prism

Rspress V2 默认使用 Shiki v3 进行代码高亮，Prism 已被移除。

### 配置迁移

- before:

```ts title="rspress.config.ts"
export default {
  markdown: {
    highlightLanguages: [['js', 'javascript']],
  },
};
```

- after:

```ts title="rspress.config.ts"
export default {
  markdown: {
    shiki: {
      langAlias: {
        js: 'javascript',
      },
    },
  },
};
```

### 行高亮语法变更

行高亮不再使用 `{1,3-4}` 语法，改为使用注释标记：

- before:

````md
```ts {1,3-4}
const a = 1;
const b = 2;
const c = 3;
const d = 4;
```
````

- after:

````md
```ts
const a = 1; // [!code highlight]
const b = 2;
// [!code highlight:2]
const c = 3;
const d = 4;
```
````

如需兼容旧语法，可添加 transformer：

```ts title="rspress.config.ts"
import { transformerCompatibleMetaHighlight } from '@rspress/core/shiki-transformers';

export default {
  markdown: {
    shiki: {
      transformers: [transformerCompatibleMetaHighlight()],
    },
  },
};
```

## [重要] 顶层导航文件重命名

最顶层的 `_meta.json` 需重命名为 `_nav.json`，否则不会生成 `themeConfig.nav`。

- before:

```
docs/
├── zh/
│   └── _meta.json
```

- after:

```
docs/
├── zh/
│   └── _nav.json
```

## [重要] SSG 默认严格模式

SSG 现在默认为严格模式，失败时直接退出构建，不再回退到 CSR。`ssg.strict` 配置已移除。

如需跳过 SSG，设置 `ssg: false`：

```ts title="rspress.config.ts"
export default {
  ssg: false,
};
```

## base 配置重新实现

`base` 配置现在基于 react-router 的 `basename` 实现。

主要变化：
- `useLocation().pathname` 不再包含 `base` 前缀
- 应使用 `Link` / `useNavigate` 进行导航，避免直接操作 `window.location`

## cleanUrls 链接变更

当 `cleanUrls: true` 时，生成的链接不再包含 `/index` 后缀。

- before: `/guide/index`
- after: `/guide`

## builderPlugins 配置移除

`builderPlugins` 已移除，请迁移到 `builderConfig.plugins`。

- before:

```ts title="rspress.config.ts"
export default {
  builderPlugins: [pluginFoo()],
};
```

- after:

```ts title="rspress.config.ts"
export default {
  builderConfig: {
    plugins: [pluginFoo()],
  },
};
```

## Sass/Less 需手动安装

内置的 Sass/Less 插件已移除，如需使用请手动安装：

```bash
# Sass
npm add @rsbuild/plugin-sass -D

# Less
npm add @rsbuild/plugin-less -D
```

并在配置中注册：

```ts title="rspress.config.ts"
import { pluginSass } from '@rsbuild/plugin-sass';

export default {
  builderConfig: {
    plugins: [pluginSass()],
  },
};
```

## 外部代码块语法变更

外部示例代码块语法已变更：

- before:

```tsx
<code src="./example.tsx" />
```

- after:

````md
```tsx file="./example.tsx"
```
````

## 相对链接解析变更

相对链接不再需要 `./` 前缀，以下两种写法现在等效：

```md
[subfolder](subfolder)
[subfolder](./subfolder)
```

## 默认开启的功能

以下功能在 V2 中默认开启：

| 功能 | 说明 |
| --- | --- |
| `markdown.link.checkDeadLinks` | 死链检查，日志更严格 |
| `search.codeBlocks` | 搜索结果包含代码块 |
| `dev.lazyCompilation` | 懒编译加速开发启动 |
| `performance.buildCache` | 持久化缓存加速构建 |

如需关闭懒编译：

```ts title="rspress.config.ts"
export default {
  builderConfig: {
    dev: {
      lazyCompilation: false,
    },
  },
};
```

## MDX 文件路由排除

以下划线 `_` 开头的文件会自动从路由中排除，适合用于 MDX 片段和 React 组件。

```
docs/
├── guide/
│   ├── _components.tsx  # 不会生成路由
│   └── index.mdx
```

## 主题样式变更

### Tailwind 类名前缀

内置主题类名添加了 Tailwind 前缀以避免冲突。如果你依赖 `dark:hidden` 等类名，请在项目中配置 Tailwind/UnoCSS。

### 原生 HTML 标签样式

原生 HTML 标签默认带有文档样式。如需隔离样式，添加 `.rp-not-doc` 类名：

```html
<div class="rp-not-doc">
  <!-- 不受文档样式影响 -->
</div>
```

### 内置多语言文案

默认主题内置了多语言翻译文案。如需覆盖，使用 `i18nSource` 而非手动编写 `themeConfig.locales`。

## React 与 React Router 版本

| 依赖 | 默认版本 | 兼容版本 |
| --- | --- | --- |
| React | 19 | 18, 19 |
| react-router-dom | 7 | 6, 7 |

React 17 不再支持。

## unified 升级

`unified` 升级到 v11，自定义的 remark/rehype 插件需兼容 `unified@11`。

## 参考资源

- [GitHub 讨论：Rspress v2 Breaking Changes](https://github.com/web-infra-dev/rspress/discussions/1891)
