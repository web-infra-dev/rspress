# 从 Rspress V1 迁移

> 参考来源：discussion #1891 的 V2 breaking changes（详见仓库根目录 `V2-breaking.md`）。

## 快速检查清单

- Node 版本 ≥ 20；React 默认 19（兼容 18）。
- 依赖重命名：使用 `@rspress/core` 及其子路径，移除 `rspress` 包。
- 自定义主题：使用 `@rspress/core/theme-original`，改为命名导出。
- SSG 默认严格、不再回退 CSR；`ssg.strict` 已移除。
- Shiki 默认开启，Prism 移除；行高亮语法更新；`markdown.highlightLanguages` 移除。
- `cleanUrls: true` 时链接去掉 `/index`。
- `base` 基于 react-router `basename` 重实现；`useLocation().pathname` 不含 base。
- `_meta.json` 顶层改名 `_nav.json` 以启用导航。
- `markdown.link.checkDeadLinks`、`search.codeBlocks` 默认开启。
- Sass/Less 插件需自行安装；`builderPlugins` 改为 `builderConfig.plugins`。

## 1. 包名与依赖

```diff
- "rspress": "^1.x"
- "rspress/runtime"
- "rspress/theme"
+ "@rspress/core": "^2.0.0"
+ import { usePageData, useDark } from '@rspress/core/runtime'
+ import { HomeLayout } from '@rspress/core/theme-original'
```

- 移除 `rspress`、`@rspress/theme-default` 等独立包，统一使用 `@rspress/core` 子路径。
- 插件/类型：`import type { RspressPlugin } from '@rspress/core'`。

## 2. 顶层导航文件

将最顶层的 `_meta.json` 重命名为 `_nav.json`，否则不会生成 `themeConfig.nav`。

```diff
- docs/zh/_meta.json
+ docs/zh/_nav.json
```

## 3. 自定义主题改为命名导出

```diff
- import Theme from 'rspress/theme'
- export default { ...Theme, Layout }
- export * from 'rspress/theme'
+ import { Layout as BasicLayout } from '@rspress/core/theme-original'
+ const Layout = () => <BasicLayout beforeNavTitle={<div>content</div>} />
+ export { Layout }
+ export * from '@rspress/core/theme-original'
```

## 4. 配置与路由

- `base` 依赖 react-router `basename`，使用 `Link` / `useNavigate`，不要用硬编码 `window.location`。
- `cleanUrls: true` 时生成的链接不再包含 `/index`。
- MDX 片段/组件：下划线前缀文件自动被路由排除（`route.excludeConvention`）。

## 5. 构建与运行时

- SSG 默认严格：失败即退出；如需跳过 SSG，设 `ssg: false`。
- `dev.lazyCompilation` 默认开启；若与预加载冲突，可在 `builderConfig.dev.lazyCompilation = false`。
- `performance.buildCache` 默认开启，加速 dev/build。
- `builderPlugins` 移除，迁移到 `builderConfig.plugins`：

```diff
- builderPlugins: [pluginFoo()]
+ builderConfig: { plugins: [pluginFoo()] }
```

- Sass/Less 需手动安装：`@rsbuild/plugin-sass`、`@rsbuild/plugin-less`。

## 6. Markdown 与代码高亮

- 默认使用 Shiki（v3）；卸载 `@rspress/plugin-shiki`。配置改为 `markdown.shiki`。
- 行高亮语法改为 notation：

```md
```ts
console.log('A') // [!code highlight]
// [!code highlight:2]
console.log('B')
console.log('C')
```
```

- 兼容旧 `{1,3-4}` 语法：添加 `transformerCompatibleMetaHighlight()`。
- `markdown.highlightLanguages` 移除，用 `markdown.shiki.langAlias` / `langs`。
- 外部示例代码块：

```diff
- <code src="./example.tsx" />
+ ```tsx file="./example.tsx"
+ ```
```

## 7. 链接、搜索与校验

- `markdown.link.checkDeadLinks` 默认开启，日志更严格。
- 相对链接无需 `./` 前缀：`[subfolder](subfolder)` 等同 `[subfolder](./subfolder)`。
- 搜索默认包含代码块：`search.codeBlocks: true`。

## 8. 样式与主题

- 内置主题类名加入 Tailwind 前缀，避免冲突；如依赖 `dark:hidden` 等类，请在项目配置 Tailwind/UnoCSS。
- 原生 HTML 标签默认带样式；需要隔离时加 `.rp-not-doc`。
- 默认内置多语言文案，移除手写 `themeConfig.locales` 文本，改用 `i18nSource` 覆盖缺失项。

## 9. 版本要求

- Node >= 20。
- React 默认 19（兼容 18）；`react-router-dom` 默认 7（兼容 6）。

## 10. 参考

- 全量 breaking list：仓库根目录 `V2-breaking.md`
- 讨论帖：https://github.com/web-infra-dev/rspress/discussions/1891
